<select id="video-filter">
  <option value="all">Todos</option>
  <option value="shorts">Solo Shorts</option>
  <option value="videos">Solo Videos</option>
</select>
<div id="videos-container"></div>
<div id="popular-videos-container"></div>
<p id="last-viewed-date"></p>

<script>
  const API_KEY = "YOUR_YOUTUBE_API_KEY";
  const CHANNEL_ID = "UCw_SZuRMPAFSxWFGr3IhAZQ";
  const UPLOADS_PLAYLIST_ID = `UU${CHANNEL_ID.substring(2)}`;

  const videosContainer = document.getElementById("videos-container");
  const popularVideosContainer = document.getElementById("popular-videos-container");
  const filterSelect = document.getElementById("video-filter");
  const lastViewedElement = document.getElementById("last-viewed-date");

  // Save & display last viewed date
  const lastViewDateKey = "lastViewedDate";
  const lastViewed = localStorage.getItem(lastViewDateKey);
  lastViewedElement.innerHTML = lastViewed ? `Última visita: ${new Date(lastViewed).toLocaleDateString()}` : "Primera vez aquí!";
  localStorage.setItem(lastViewDateKey, new Date().toISOString());

  async function fetchVideos(filterType = "all") {
    try {
      const response = await fetch(`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet,contentDetails&playlistId=${UPLOADS_PLAYLIST_ID}&maxResults=12&key=${API_KEY}`);
      const data = await response.json();
      if (!data.items) throw new Error("No videos available");

      const videoMap = {};
      data.items.forEach(item => videoMap[item.contentDetails.videoId] = item.snippet);

      const videoIds = Object.keys(videoMap).join(",");
      const detailsResponse = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=contentDetails,statistics&id=${videoIds}&key=${API_KEY}`);
      const detailsData = await detailsResponse.json();

      const filteredVideos = detailsData.items.filter(video => {
        const duration = video.contentDetails.duration;

        // Fixed shorts detection logic
        const match = duration.match(/PT(?:(\d+)M)?(?:(\d+)S)?/);
        const minutes = parseInt(match?.[1] || 0);
        const seconds = parseInt(match?.[2] || 0);
        const totalSeconds = minutes * 60 + seconds;
        const isShort = totalSeconds > 0 && totalSeconds <= 60;

        return filterType === "shorts" ? isShort : filterType === "videos" ? !isShort : true;
      }).map(video => ({
        ...video,
        snippet: videoMap[video.id]  // match video.id to snippet
      }));

      videosContainer.innerHTML = filteredVideos.map(video => {
        const snippet = video.snippet;
        const thumbnailUrl = (snippet.thumbnails.high || snippet.thumbnails.default).url;
        return `
          <div class="video-card">
            <div class="thumbnail"><img src="${thumbnailUrl}" alt="Thumbnail"></div>
            <div class="video-info">
              <div class="video-title">${snippet.title}</div>
              <div class="video-stats">${video.statistics.viewCount} vistas</div>
            </div>
          </div>
        `;
      }).join("");
    } catch (error) {
      videosContainer.innerHTML = `<div>Error cargando videos: ${error.message}</div>`;
    }
  }

  async function fetchPopularVideos() {
    try {
      const response = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics&chart=mostPopular&regionCode=US&key=${API_KEY}&maxResults=5`);
      const data = await response.json();
      if (!data.items) throw new Error("No popular videos found");

      popularVideosContainer.innerHTML = data.items.map(video => {
        const thumbUrl = (video.snippet.thumbnails.high || video.snippet.thumbnails.default).url;
        return `
          <div class="video-card">
            <div class="thumbnail"><img src="${thumbUrl}" alt="Thumbnail"></div>
            <div class="video-info">
              <div class="video-title">${video.snippet.title}</div>
              <div class="video-stats">${video.statistics.viewCount} vistas</div>
            </div>
          </div>
        `;
      }).join("");
    } catch (error) {
      popularVideosContainer.innerHTML = `<div>Error cargando videos populares: ${error.message}</div>`;
    }
  }

  filterSelect.addEventListener("change", () => fetchVideos(filterSelect.value));

  fetchVideos();
  fetchPopularVideos();
</script>
